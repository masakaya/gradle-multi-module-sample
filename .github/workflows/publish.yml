name: Publish to GitHub Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    services:
      mysql:
        image: mysql:8.4.5
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: mydb
          MYSQL_USER: dbuser
          MYSQL_PASSWORD: dbpassword
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -prootpassword"
          --health-interval=10s
          --health-timeout=10s
          --health-retries=10

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Install MySQL Client
      run: |
        sudo apt-get update
        sudo apt-get install -y mysql-client-core-8.0

    - name: Wait for MySQL
      run: |
        echo "Waiting for MySQL service to be ready..."
        for i in {1..30}; do
          if mysqladmin ping -h"127.0.0.1" -P"3306" -u"dbuser" -p"dbpassword" --silent; then
            echo "MySQL is ready!"
            break
          else
            echo "Attempt $i/30: MySQL not ready yet, waiting 5 seconds..."
            sleep 5
          fi
        done
        
        # Verify connection one more time
        echo "Final connection test..."
        mysqladmin ping -h"127.0.0.1" -P"3306" -u"dbuser" -p"dbpassword" --silent || {
          echo "ERROR: Could not connect to MySQL"
          exit 1
        }

    - name: Run database migrations
      run: ./gradlew :persistence-module:flywayMigrate
      env:
        ORG_GRADLE_PROJECT_db_url: jdbc:mysql://127.0.0.1:3306/mydb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
        ORG_GRADLE_PROJECT_db_user: dbuser
        ORG_GRADLE_PROJECT_db_password: dbpassword

    - name: Build persistence module
      run: ./gradlew :persistence-module:build
      env:
        ORG_GRADLE_PROJECT_db_url: jdbc:mysql://127.0.0.1:3306/mydb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
        ORG_GRADLE_PROJECT_db_user: dbuser
        ORG_GRADLE_PROJECT_db_password: dbpassword

    - name: Publish to GitHub Packages
      run: ./gradlew :persistence-module:publish
      env:
        USERNAME: ${{ github.actor }}
        TOKEN: ${{ secrets.GITHUB_TOKEN }}